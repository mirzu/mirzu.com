---
import { Image } from 'astro:assets'
import type { ImageMetadata } from 'astro'

interface ImageGridProps {
	images: {
		src: ImageMetadata
		alt: string
		caption?: string
	}[]
	columns?: 2 | 3 | 4
}

const { images, columns = 3 } = Astro.props as ImageGridProps

const gridClass = {
	2: 'grid-cols-2 sm:grid-cols-2',
	3: 'grid-cols-2 sm:grid-cols-3',
	4: 'grid-cols-2 sm:grid-cols-4',
}[columns]
---

<section class="image-grid-container">
	<!-- Thumbnail grid -->
	<div class={`grid ${gridClass} gap-4 my-8`}>
		{
			images.map((image, index) => (
				<button
					type="button"
					class="relative aspect-square cursor-zoom-in group focus:outline-none focus-visible:ring-2 focus-visible:ring-primary dark:focus-visible:ring-primary-dark rounded-lg overflow-hidden"
					data-lightbox-trigger
					data-index={index}
					aria-label={`View full size: ${image.alt}`}
				>
					<Image
						alt={image.alt}
						src={image.src}
						width={500}
						height={500}
						class="rounded-lg object-cover w-full h-full transition-transform duration-300 group-hover:scale-105"
					/>
				</button>
			))
		}
	</div>

	<!-- Lightbox overlay -->
	<div
		class="lightbox-overlay"
		data-lightbox-overlay
		role="dialog"
		aria-modal="true"
		aria-label="Image lightbox"
	>
		<!-- Full-size images (one per image, toggled by JS) -->
		{
			images.map((image, index) => (
				<div
					class="lightbox-slide"
					data-lightbox-slide={index}
					data-caption={image.caption || image.alt}
				>
					<Image
						alt={image.alt}
						src={image.src}
						width={Math.min(image.src.width, 1920)}
						class="lightbox-full-image"
					/>
				</div>
			))
		}

		<!-- Caption -->
		<p
			class="absolute bottom-12 left-1/2 -translate-x-1/2 text-white/80 text-sm text-center max-w-xl"
			data-lightbox-caption
		>
		</p>

		<!-- Image counter -->
		<div
			class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white/60 text-sm"
			data-lightbox-counter
		>
		</div>
	</div>
</section>

<style>
	.lightbox-overlay {
		position: fixed;
		inset: 0;
		z-index: 50;
		display: none;
		align-items: center;
		justify-content: center;
		backdrop-filter: blur(4px);
	}

	.lightbox-overlay.is-open {
		display: flex;
	}

	.lightbox-slide {
		display: none;
		position: absolute;
		inset: 0;
		padding: 3rem;
		text-align: center;
	}

	.lightbox-slide.is-active {
		display: flex;
	}

	.lightbox-full-image {
		max-width: 90vw;
		max-height: 80vh;
		width: auto;
		height: auto;
		object-fit: contain;
		border-radius: 0.5rem;
	}

	@media (prefers-reduced-motion: reduce) {
		[data-lightbox-trigger] img {
			transition: none !important;
		}
	}
</style>

<script>
	function initLightboxes() {
		const containers = document.querySelectorAll('.image-grid-container')

		containers.forEach((container) => {
			const triggers = container.querySelectorAll('[data-lightbox-trigger]')
			const overlay = container.querySelector(
				'[data-lightbox-overlay]'
			) as HTMLElement | null
			const slides = container.querySelectorAll('[data-lightbox-slide]')
			const caption = container.querySelector(
				'[data-lightbox-caption]'
			) as HTMLElement | null
			const counter = container.querySelector(
				'[data-lightbox-counter]'
			) as HTMLElement | null
			if (!overlay || !slides.length || !triggers.length) return

			let currentIndex = 0
			let previouslyFocused: HTMLElement | null = null
			const totalImages = slides.length

			function showImage(index: number) {
				currentIndex = index

				// Hide all slides, show the active one
				slides.forEach((slide, i) => {
					slide.classList.toggle('is-active', i === index)
				})

				const activeSlide = slides[index] as HTMLElement
				if (caption) caption.textContent = activeSlide.dataset.caption || ''
				if (counter) counter.textContent = `${index + 1} / ${totalImages}`

			}

			function openLightbox(index: number) {
				previouslyFocused = document.activeElement as HTMLElement
				showImage(index)
				overlay!.classList.add('is-open')
				document.body.style.overflow = 'hidden'
			}

			function closeLightbox() {
				overlay!.classList.remove('is-open')
				document.body.style.overflow = ''
				previouslyFocused?.focus()
			}

			triggers.forEach((trigger) => {
				trigger.addEventListener('click', () => {
					const index = parseInt(
						(trigger as HTMLElement).dataset.index || '0',
						10
					)
					openLightbox(index)
				})
			})

			overlay.addEventListener('click', (e) => {
				const target = e.target as HTMLElement
				// Close if clicking the overlay backdrop or a slide container (not the image itself)
				if (target === overlay || target.hasAttribute('data-lightbox-slide')) {
					closeLightbox()
				}
			})

		})
	}

	// Module scripts are deferred, so DOM is already ready
	initLightboxes()
	// Handle Astro View Transitions if ever added
	document.addEventListener('astro:page-load', initLightboxes)
</script>
